                                                                                          //=+++++++++=
                                                                                        const/*==+++==--:
                      .--.          .--.                                               *+++====----===+++---
            .--.--.--.|--|.--.--..--|  |.-----..--.--.                              +++===----------=++=----
            |  |  |  ||  ||__ __||  _  ||  -__||__ __|                            *+++==*/jsonFiles/*===+---:
            |________||__||__.__||_____||_____||__.__|                          -=+++===++++++****++=---=----
                                                                              *-=++=++++**++*+++*/=/**-=-:--
                                                                               *+*+++=+++*++*******=--::----
                                                                        --------=+*+*+---==+*****+++++++=-----
                                                                    --===*/[//===+++*+===-=+***+++===++++------=
'cards/servant.json'                                           /*-===========+=*+*/,//====+=+****++++======-----=
                                             //:--=          =========---------==+++--=====*****+=---=====----=+=++
                                     //-----------====   =======-----------=+===+*+=====+***++=======------==+==++
                                  //::-----------==----======-----------=====++==+**++===+***+++++==+=-----==++====
                                 //---========----=+---==============++++++==++===++=+===+****+++++**+-=-====*+=====
                             //::--=++=++******+=--=+=----=+++++++++++++==--=-::   :=*:::=*++=++*****+======+*+==+++
                           //:--=***+++++++++==+++=-=----==+++**++=--.     -:     ::      *+--+*****==-===+**===+*
                         //-::-=+**+++++++++++++===++==---+==*++=:                 -         =:*++*=-====+++*+==+*+
                        //=-::-+*#**+++******+++++=++++==+++=-                    :-           ++=----==++**+===**
                     //=****       ...++++++**+  ++                          ::--=    ======+==++=--+**+=+++=-
                //=+==+====***        ...:+=++*+=   ++                         -=--==  -+=====*++++--=+***+++=+===
              //-=========+**        .....=***+    =*+                        :-+====--*+===+**++---=+***+++=+==++==
             //:-====---===*-       =-:....+*+     *-                        ::==-===**+++++***+---=*****+++++===+=====++===
            //-:--+-==----=+-     ###-:::...-                               :-=====+***+++****=--=+*****+++++=====+=========
'cards/WXDi-P12.json',//--:--  *#**+=........                              :-=+===+*****+****=--=+******+++++=====++++=======
'cards/WXDi-P13.json',//=--::--=+++=:...:::...                            ======-=+****+*++*=-=+*********+++=====++++++==---===
//            :-=============---===+=-::::......                       ::--------=+##**+=+*==*****#******+*+====++++++++===---===:
//             --==========++++++++++--:::::::---.          ===        -:--=+====+*##*+=+*+*****#****/,/**+++===++++=++===---==:
'cards/WXDi-P15.json',//=====+++++=====-:::::--.:-        ------ =   -===++====+*##*==**+=+*##**#**+****++++===+++++==--:
'cards/WXDi-P16.json'/*----=====+********+-::::::---+   :::::---==+++-=====*/,//#**+=++++*##=+**+**+****=++++==-++=+++-=-:
'cards/WX24-P1.json',//--------=+*#**++++-::::::::::------::::::---=+==++=====+##*******###***-**+:+*****+++++==--=+==++=
'cards/WX24-P2.json',//++++++******+++*****=-::.:-====---:--------==+**=--=++++######********+:*+:-******=++++==-  == ==
'cards/WX24-P3.json' /****++++=====++****-:----==----:-=========++*+-::.:=*###***+++**-+*--+:-=*****==++++=--
                    #+    +==---==+********==--===---==--++++++=+++*#*-::::..-=:::::-=**=-=:----*****+-+++++=-:
                     *.    **********+++=++*#*+-=====+==+***+*+++**##+-::::::-:::::=+++=::----=+*++*++**++===--:
                      *+   ++****++++++++***##*--++=+*++=+*+++++******#=-:---=--:::---=*+:::---=--=+****++=====
                        .++++++++++++++++*####=-=*=+**+=++++**+++***   #+=-=--:::::-*+-:::-----=+    +**+++====
                        =+++++******++++*####==+**+****++-=+===-=++=   *##+=---=--+=-.:.-----        =++++===:
                      *===+++++****++++*#*  -=++++****+-=::---:-==+     ###****+#+:..:..-*=-=        +++++==
                    :==+==+++++++*+++*      ++==++***  ##::------=*      +##***+:...:-:::###%       -+++++=
                   ========+++++++*=       :==:-  *     ##-=++=--++        ##=....::::-::=%%%#      +++++=
               -==========+==+==+=                        *##****#          -:....::::--::*%#%      ++++==
             *=-==============++=                            .-=+           .:.....::::::::++##.   =++++-
           ===-=========---==+*+=              *             .-=+       :.::::::::.::.....::..=#* ==+++            .:
            ====--=====+  ===+++=             ++              -=++=-:.:--::-- :::::::::........:*#*+++           :::
            ====..-=  =   +=+=**=             *+             -:=-=:..::=+=:    :::::::::::.......:..::      .   ::::  ..:
             *=-   =      ++++**-  .:::..:-=+--===        ++===+=:::::-         ::::::::::::::::::::::::--  :: :::::::::
                        --=+++=::..:::...:-*-:...:-:::-+***++=+=--=--=           ::::::::::::::::::::::::-----::::::::..
                          *++=::.:::.....-##+--::-=-****#+-=+*+--===--           ::::::::::::::::::--------------:::::::
                            =:::::......:#%%#*   =*##*##+=++=++=----=             :::::::::::::::-----------------:-::
                            ::..........*#%%      #####+-*#=###**--=                ::::::::::::::::--------------::::
                           *::.........=#%%       ###*##+*+#*###**=                   ::::::::::::::::-------------::::--:
                            .::::::::::*%%        *##%#+==++***#*=*                   .::::--:::::::::::----------:-
                            :::::::::---#%        *--*-...-:-=**#*:                 +++==-       :::::--------------:
                             ::----------=-.-=====:......:..::=+##                 ++===              -----         :
                             :---------------==--:.........::--=%                 ++==+
                              ----------========+:.......::----+                -+==++++++++-----=:
                               ++=-------=======+:......::----++                -:::-====-++=-----=-
                                ++=- -----=======.....:::.:--=+=               .....:-=++++=-------=-
                                 ++=   -----=====.:::::..:=--++=-            ......:::--::.:::::::::--
                                  +=.     ======:::..:..:=---+=.=          ...................:::::::-:
                                  .+=      =++  ....:...==:::=-.-      .......................:::::::::
                                    +=      =+  ......:+=-:-==-.:=  -=-.....................:::::::::::
                                     ==-  +     .....-++*#####=.::---:..:.................::::::::::::::
                                       ===*    ....***###*==-.:.:.--:.::...:::.....::::::::---::::::::::
                                        ==#%#-...-+*#%*=-::::::.::-::..:::::...........::----::::::::-:-
                                       :-*#%+..:==+#*::--:....::::::..................::-----------:::::
                                    =+*+*#=-::---+##::-::------::..::::::.........::::-------::::::::::::
                                    ::::###+-:--*#*-::--::-----::.:.-:-:.........::::---::::........:::::
                                  ::::::-###*+-+**+:::....::--::::.::-.  ::   ....::::.................::
                                 :::::...++**##***-::.....::::::-:::-:                       ........:::::
                                :::-=+**+-::-=*#**::......:::::.-::--:                            .....:::
                    -          ...-=-:...:::::-=*=:......:::::::=::-:..:                            .....::
               ...:=.:-:=-   :.........:::  ===--:......::::::::-:::..:-                              .....
               ...:===---..::........:--    =----:......:::::::--::::::                                 ::.
              .......:.............:-=      -:::::.....::::::::--:::::-                                  ::
             ....................:           ::::.....:::::::::--=--:::::                                 :
          ..............:::....:             ::::....:::::::  -::=--::
         ..........:::::......-              ::::....::::::   :-:-----
        ........::::........:.               ::::...::::::    :-:::::
        ....::::::.......:--                  :::...::::::    --:-::
       .:.:::::::.....:----                   :::...::::::    :--::
        :::::.:......------                    ::..:::-:--    ----
          ::::.....:------                     ::::::---=+::::--:::          -
           :::....-:                            :::::------.::-::::         ---
             ....                                ::::------:::::::::::::::-------
             :..                                  ::-------:::::::--:::::---------::                              -
             :..                                  ::----==:::               .-  -----+                          -==-
             :::                                    --==--::                       +*+                        -=- --
 -----        :::                                    -------                          :                      =-   --
-----=--                                              ::----                                               --     -
---=-  ---                                             ::::::                                             =-      -*
:--=     --                                             ::::--=-                                         =       -*
 --=       =-                                            ::::--:                                       :-       --*
 --=        =-               ::                           :::::::                                     --        =*
  --.        =-              .::::                        :::---:                                    -:        -*
  ---         -=          ::::::::.::                   .::----::                                   -         -.
   --          ==       .....:::::::::--:           ---   :----:--                                 -         -:
   ---          =-          :::::::::::::::::--------       -:::--                                --        --
    =-           =-            :  .:::::::::::-----          .:---                               --        --
     =-           =-                ::::::--:----            :::::                              --        --
      =-          =-.                 :  ::-----              ::::                             --        -:
      -=           =-                         :               .::-:                            --       -.
       --           -=                                         :-::                           --       -
        =-          =-                                         ::::                          :--     :-
         =-         =-=                                         :::                          ---    --
          =-         =-                                         :::                         ----  --
           =-        =-=                                         ::                         ------.
            --       --=                                         ::                         ----.
              --     --=                                         .:-                         -
               ---  --==-                                         ::
                 ----===                                          ::
                   ---==                                          ::
                    --=                                          :::
                                                                .:::
                                                                -:::.
                                                                */]/*
                                                                 *//*
                                                                  //:
                                                                   */
                                                                    ;

/* --------------------------------------------------------------------------------------------------------------------------------------- */

/* グローバル変数 */

/* すべてのカードデータ */
let allCardsData = [];
/* フリック・タップしたカード */
let currentCard;
/* タッチ開始時のY座標初期値 */
let touchStartY = 0;
/* タッチ開始時間 */
let touchStartTime = 0;
/* LB検索ボタンのステータス */
let lifeBurstState = 0;


/* --------------------------------------------------------------------------------------------------------------------------------------- */

/* DOM読込完了時に実行 */
document.addEventListener('DOMContentLoaded', () => {

/* --------------------------------------------------------------------------------------------------------------------------------------- */


/* 最初の処理 */


/* htmlの要素を取得 */

/* ルリグデッキのカード欄 */
const lrigDeckCards = document.querySelector('.lrig-deck-cards');
/* メインデッキのカード欄 */
const mainDeckCards = document.querySelector('.main-deck-cards');
/* リスト欄 */
const cardsList = document.querySelector('.cards-list');
/* レベル検索ボタン */
const levelButtons = document.querySelectorAll('.search-level-button');
/* 色検索ボタン */
const colorButtons = document.querySelectorAll('.search-color-button');
/* LB検索ボタン */
const lifeBurstButton = document.querySelector('.search-lb-button');
/* テキスト検索欄 */
const searchTextInput = document.querySelector('.search-text-input');
/* ポップアップのオーバーレイ */
const popupOverlay = document.querySelector('.popup-overlay');
/* カード情報ポップアップ */
const cardDetailPopup = document.querySelector('.card-detail-popup');
/* カード情報ポップアップのカード画像 */
const cardImageDetail = document.querySelector('.card-image-detail img');


/* jsonファイルからカードのデータを取得し、リスト欄に表示 */
Promise.all(jsonFiles.map(file => fetch(file)                      // jsonFilesの各要素をfetchで取得
    .then(response => response.json())                                // 取得してきたもの（response）をjsonにする
))
.then(responses => {
    responses.forEach(responseData => {                               // すべてのjsonを取得したら、forEachを実行
        allCardsData = allCardsData.concat(responseData);                // 取得したjsonたちを、allCardsDataにまとめる
    });
    window.cardsData = allCardsData;                                  // windowオブジェクトにする
    displayCards(window.cardsData);                                   // リスト欄に表示
})
.catch(error => {
    console.error("JSONファイルが読み込めなかったっぽい!:", error);   // エラーが出たら困る
});


/* htmlの要素に処理を追加 */

/* レベル検索ボタン */
const selectedLevels = new Set();                        // 選択されたレベルを管理するSetを作成
levelButtons.forEach(button => {
    button.addEventListener('click', () => {
        const level = parseInt(button.dataset.level, 10);   // 押されたボタンのdataset.levelを数値で取得
        /* ボタンのオン・オフを切り替え */
        if (selectedLevels.has(level)) {                    // 押されたボタンのlevelがすでにSetにある場合(オン状態のボタンを押した)
            selectedLevels.delete(level);                      // Setから押されたボタンのlevelを削除
            button.classList.remove('active');                 // ボタンのactiveを外す
        } else {                                            // ない場合(オフ状態のボタンを押した)
            selectedLevels.add(level);                         // Setに押されたボタンのlevelを追加
            button.classList.add('active');                    // ボタンをactiveに
        }
        /* 検索を実行 */
        handleSearch();
    });
});

/* 色検索ボタン */
const selectedColors = new Set();             // 選択された色を管理するSetを作成
colorButtons.forEach(button => {
    button.addEventListener('click', () => {
        const color = button.dataset.color;      // 押されたボタンのdataset.colorを取得
        /* ボタンのオン・オフを切り替え */
        if (selectedColors.has(color)) {         // 押されたボタンのcolorがすでにSetにある場合(オン状態のボタンを押した)
            selectedColors.delete(color);           // Setから押されたボタンのcolorを削除
            button.classList.remove('active');      // ボタンのactive状態を外す
        } else {                                 // ない場合(オフ状態のボタンを押した)
            selectedColors.add(color);              // Setに押されたボタンのcolorを追加
            button.classList.add('active');         // ボタンをactiveに
        }
        /* 検索を実行 */
        handleSearch();
    });
});

/* LB検索ボタン */
lifeBurstButton.addEventListener('click', function() {
    lifeBurstState = (lifeBurstState + 1) % 3;             // クリックごとにlifeBurstStateを1増やす(0→1→2→0のループ)
    /* 状態に応じてボタンの背景色を変更 */
    switch (lifeBurstState) {
        case 0:                                            // デフォルト(LBありなしどっちもで検索)
            this.classList.remove('active', 'inactive');      // active,inactiveを削除
            break;
        case 1:                                            // LBあり
            this.classList.add('active');                     // activeを追加
            this.classList.remove('inactive');                // inactiveがあったら削除
            break;
        case 2:                                            // LBなし
            this.classList.add('inactive');                   // inactiveを追加
            this.classList.remove('active');                  // activeを削除
            break;
    }
    /* 検索を実行 */
    handleSearch();
});

/* テキスト検索欄 */
searchTextInput.addEventListener('input', handleSearch);   // 文字が入力されたら検索を実行

/* ポップアップのオーバーレイ */
popupOverlay.addEventListener('click', function() {
    const activePopup = popupOverlay.dataset.activepopup;
    document.querySelector(`.${activePopup}`).classList.remove('active');
    popupOverlay.classList.remove('active');
})

/* ルリグタイプ/クラスのポップアップ */
    const searchLrigTypeClassPopup = document.querySelector('.search-lrigTypeClass-popup')                        // ルリグタイプ/クラス検索ポップアップを取得
    const openSearchLrigTypeClassPopupButton = document.querySelector('.open-searchLrigTypeClassPopup-button');   // ルリグタイプ/クラス検索ポップアップを表示させるボタンを取得
    openSearchLrigTypeClassPopupButton.addEventListener('click', function() {                                     // ボタンを押したときの処理を追加
        searchLrigTypeClassPopup.classList.add('active');                                                           // classにactiveを追加(ポップアップを表示)
    });
    /* 検索ボタンの設定 */
    const searchLrigTypeClassButtons = document.querySelectorAll('.search-lrigTypeClass-button');                 // ポップアップ上のボタンたちを取得
    searchLrigTypeClassButtons.forEach(button => {
        /* ボタンを押したときの処理を追加 */
        button.addEventListener('click', function() {
            const selectedLrigTypeClass = button.dataset.lrigtypeclass;                                             // 押したボタンのdatasetを取得
            openSearchLrigTypeClassPopupButton.dataset.selectedLrigTypeClass = selectedLrigTypeClass;               // 押したボタンのdatasetを表示ボタンに渡す(検索に使用)
            const openPopupButtonImg = openSearchLrigTypeClassPopupButton.querySelector('img');                     // 検索ポップアップを表示させるボタンのimgを取得
            const selectedLrigTypeClassImg = button.querySelector('img').src;                                       // 押したボタンのimg(src)を取得
            openPopupButtonImg.src = selectedLrigTypeClassImg;                                                      // 押したボタンのimgを表示ボタンに渡す
            searchLrigTypeClassPopup.classList.remove('active');                                                    // activeを外す(ポップアップを非表示)
            handleSearch();                                                                                         // 検索を実行
        });
    });


/* ステータス欄を更新(初期化) */
updateDeckStatus();


/* --------------------------------------------------------------------------------------------------------------------------------------- */



/* 関数 */


/* カードを検索 */
function handleSearch() {
    /* 検索結果を一度リセット */
    cardsList.innerHTML = '';

    /* 検索条件を取得 */
    const searchText = searchTextInput.value.toLowerCase();                                               // #search-text-inputからテキストを取得（小文字に変換）しsearchTextにする
    const selectedCardType = document.getElementById('search-cardType-popup').dataset.selectedCardType || "";                          // #search-cardType-inputドロップダウンから選ばれたカード種類を取得してselectedCardTypeにする
    const selectedLrigTypeClass = document.querySelector('.open-searchLrigTypeClassPopup-button').dataset.selectedLrigTypeClass || "";   // lrigTypeClassが空なら全てで検索、選択されていればselectedLrigTypeClassが含まれているか確認

    /* window.cardsDataの中からカードを検索してfilteredCardsに保存 */
    let filteredCards = window.cardsData.filter(card => {
        /* 検索条件を設定 */
        const nameMatch = card.name.toLowerCase().includes(searchText);                                                                          // カード名（小文字に変換）にsearchText含んでいるかを確認
        const subNameMatch = card.subName && card.subName.some(sub => sub.toLowerCase().includes(searchText));                                   // subNameがあれば、同様にsearchTextを含んでいるか確認
        const cardTypeMatch = selectedCardType === "" || (card.cardType && card.cardType.includes(selectedCardType));                            // selectedCardTypeが空なら全てで検索、選択されていればselectedCardTypeがcardTypeに含まれているか確認
        const lrigTypeClassMatch = selectedLrigTypeClass === "" || (card.lrigTypeClass && card.lrigTypeClass.includes(selectedLrigTypeClass));   // lrigTypeClassのフィルタリング
        const levelMatch = selectedLevels.size === 0 || selectedLevels.has(card.level);                // selectedLevelsが選択されていなければ全てで検索、選択されていればいずれかに一致するか確認
        const colorMatch = selectedColors.size === 0 || Array.from(selectedColors).some(color => card.color.includes(color));                              // selectedColorsが選択されていなければ全てで検索、選択されていればいずれかに一致するか確認
        const lifeBurstMatch = (
            (lifeBurstState === 0) ||                           // lifeBurstStateが0であれば全てで検索
            (lifeBurstState === 1 && card.lifeBurst === 1) ||   // lifeBurstStateが1であればLBありで検索
            (lifeBurstState === 2 && card.lifeBurst === 0)      // lifeBurstStateが2であればLBなしで検索
        );
        /* 全条件で検索 */
        return (nameMatch || subNameMatch) && cardTypeMatch && lrigTypeClassMatch && levelMatch && colorMatch && lifeBurstMatch;
    });

    /* 検索結果filteredCardsをdisplayCards関数で表示 */
    displayCards(filteredCards);
}


/* リスト欄にカードを表示させる関数 */
function displayCards(cards) {
    /* リスト欄にカードを表示 */
    cards.forEach(card => {
        /* cards-containerに追加する<div class="card">を作成 */
        const cardElement = document.createElement('div');              // <div>を作成（jsではcardElementで参照）
        cardElement.classList.add('card');                              // classにcardを設定
        /* <div>にカード画像<img src="URL">を追加 */
        const cardImage = document.createElement('img');                // <img>を作成
        cardImage.src = card.image;                                     // imgにsrcでカード画像（URL）を設定
        cardElement.appendChild(cardImage);                             // 作成した<img>を<div>に追加
        /* カードにフリックのリスナーを追加 */
        cardElement.addEventListener('touchstart', handleTouchStart);   // タップしたときにhandleTouchStartを呼び出すリスナーを追加
        cardElement.addEventListener('touchend', (event) => {           // タップ終了時のリスナーを追加
            currentCard = card;                                           // 触れているカードをcurrentCardとして保存(handleTouchEndで使用)
            handleTouchEndOnList(event);                                  // handleTouchEndOnListを呼び出す
        });
        /* 作成した<div>をcards-containerに追加 */
        cardsList.appendChild(cardElement);
    });
}


/* リスト欄のフリック・タップ設定 */

/* タッチ開始時 */
function handleTouchStart(event) {
    touchStartY = event.touches[0].clientY;   // タッチ開始Y座標を記録
    touchStartTime = Date.now();              // タッチ開始時間を記録
}
/* タッチ終了時 */
function handleTouchEndOnList(event) {
    const touchEndY = event.changedTouches[0].clientY;           // タッチ終了時のY座標を取得
    const swipeDistance = touchStartY - touchEndY;               // フリックの距離を計算
    const touchDuration = (Date.now() - touchStartTime) / 1000;  // タッチの持続時間を計算
    /* 上方向にフリックされた場合、デッキに1枚追加 */
    if (swipeDistance > 50 && currentCard) {
        addCardToDeck(currentCard);
    }
    /* 下方向にフリックされた場合、デッキに4枚追加 */
    else if (swipeDistance < -70 && currentCard) {
        for (let i = 0; i < 4; i++) {
            addCardToDeck(currentCard);
        }
    }
    /* タップされた場合、ポップアップで拡大表示(フリックがほぼないかつ触った時間が0.2秒未満(擬似的なタップ)) */
    else if (Math.abs(swipeDistance) < 5 && touchDuration < 0.2) {
        cardImageDetail.src = currentCard.image;
        cardDetailPopup.classList.add('active');
        popupOverlay.classList.add('active');
        popupOverlay.dataset.activepopup = ('card-detail-popup');
    }
}


/* デッキにカードを追加する関数 */
function addCardToDeck(card) {
    /* deckに追加する<div class="card">を作成 */
    const cardElement = document.createElement('div');           // <div>を作成(jsではcardElementで参照)
    cardElement.classList.add('card');                           // classにcardを設定
    /* <div>にカード画像<img src="URL">を追加 */
    const cardImage = document.createElement('img');             // <img>を作成
    cardImage.src = card.image;                                  // imgにsrcでカード画像URLを設定
    cardElement.appendChild(cardImage);                          // 作成した<img>を<div>に追加
    /* <div>にカードのデータを追加 */
    cardElement.dataset.name = card.name;                        // カード名
    cardElement.dataset.cardType = card.cardType[0];             // カード種類(配列の最初の要素)
    cardElement.dataset.lrigTypeClass = card.lrigTypeClass[0];   // ルリグタイプ/クラス(配列の最初の要素)
    cardElement.dataset.level = card.level;                      // レベル

    /* <div>のdatasetからcardTypeを取得 */
    const cardType = cardElement.dataset.cardType;
    /* ルリグならルリグデッキに追加してソート */
    if (cardType ==='ルリグ') {
        /* ルリグデッキは8枚まで */
        if (lrigDeckCards.children.length >= 8) {                                      // LrigDeckの枚数が8枚以上なら処理を停止
            return;
        }
        /* (センター)ルリグは1枚まで */
        const lrigDeckLrig = Array.from(lrigDeckCards.children).filter(deckCard => {   // ルリグデッキの中身を取得
            const deckCardType = deckCard.dataset.cardType;                               // datasetからカード種類を取得
            return deckCardType === "ルリグ";                                             // ルリグがあるか確認
        });
        if (lrigDeckLrig.length >= 1 ) {                                               // 1枚以上あるなら処理を停止
            return;
        }
        /* <div>をルリグデッキに追加 */
        lrigDeckCards.appendChild(cardElement);
        /* ルリグデッキをソート */
        sortLrigDeck();
    }
    /* アシストルリグならルリグデッキに追加してソート */
    else if(cardType === 'アシストルリグ') {
        /* ルリグデッキは8枚まで */
        if (lrigDeckCards.children.length >= 8) {                                                      // LrigDeckの枚数が8枚以上なら処理を停止
            return;
        }
        /* 同じレベルのアシストルリグは2枚まで */
        const lrigDeckSameLevelAssist = Array.from(lrigDeckCards.children).filter(deckCard => {        // ルリグデッキの中身を取得
            const deckCardType = deckCard.dataset.cardType;                                               // datasetからカード種類を取得
            const deckCardLevel = deckCard.dataset.level;                                                 // datasetからレベルを取得
            return deckCardType === "アシストルリグ" && deckCardLevel === cardElement.dataset.level;      // 追加しようとしているカードと同じレベルのアシストルリグを確認
        });
        if (lrigDeckSameLevelAssist.length >= 2) {                                                     // 2枚以上あるなら処理を停止
            return;
        }
        /* 同じルリグタイプで同じレベルのカードは1枚まで */
        const lrigDeckSameLrigTypeAssist = Array.from(lrigDeckCards.children).filter(deckCard => {     // ルリグデッキの中身を取得
            const deckLrigType = deckCard.dataset.lrigTypeClass;                                          // datasetからルリグタイプを取得
            const deckCardLevel = deckCard.dataset.level;                                                 // datasetからレベルを取得
            return deckLrigType === cardElement.dataset.lrigTypeClass && deckCardLevel === cardElement.dataset.level; // 追加しようとしているカードと同じルリグタイプかつレベルのカードがあるかをチェック
        });
        if (lrigDeckSameLrigTypeAssist.length >= 1 ) {                                                 // 1枚以上あるなら処理を停止
            return;
        }
        /* <div>をルリグデッキに追加 */
        lrigDeckCards.appendChild(cardElement);
        /* ルリグデッキをソート */
        sortLrigDeck();
    }
    /* ピースならルリグデッキに追加してソート */
    else if(cardType === 'ピース') {
        /* ルリグデッキは8枚まで */
        if (lrigDeckCards.children.length >= 8) {                                         // LrigDeckの枚数が8枚以上なら処理を停止
            return;
        }
        /* ピースは2枚まで */
        const lrigDeckPiece = Array.from(lrigDeckCards.children).filter(deckCard => {     // ルリグデッキの中身を取得
            const deckCardType = deckCard.dataset.cardType;                                  // datasetからカード種類を取得
            return deckCardType === "ピース";                                                // ピースの枚数を確認
        });
        if (lrigDeckPiece.length >= 2) {                                                  // 2枚以上あるなら処理を停止
            return;
        }
        /* 同名カードは1枚まで */
        const lrigDeckSameNameCard = Array.from(lrigDeckCards.children).filter(deckCard => {   // ルリグデッキの中身を取得
            const deckCardName = deckCard.dataset.name;                                           // datasetからカード名を取得
            return deckCardName === cardElement.dataset.name;                                     // 追加しようとしているカードと同じものがあるかどうかをチェック
        });
        if (lrigDeckSameNameCard.length >= 1) {                                                // 同じものがあるなら処理を停止
            return;
        }
        /* <div>をルリグデッキに追加 */
        lrigDeckCards.appendChild(cardElement);
        /* ルリグデッキをソート */
        sortLrigDeck();
    }
    /* アーツならルリグデッキに追加してソート */
    else if(cardType === 'アーツ') {
        /* ルリグデッキは8枚まで */
        if (lrigDeckCards.children.length >= 8) {                                              // LrigDeckの枚数が8枚以上なら処理を停止
            return;
        }
        /* 同名カードは1枚まで */
        const lrigDeckSameNameCard = Array.from(lrigDeckCards.children).filter(deckCard => {   // ルリグデッキの中身を取得
            const deckCardName = deckCard.dataset.name;                                           // datasetからカード名を取得
            return deckCardName === cardElement.dataset.name;                                     // 取得したカード名の中に、追加しようとしているカードと同じものがあるかどうかをチェック
        });
        if (lrigDeckSameNameCard.length >= 1) {                                                // 同じものがあるなら処理を停止
            return;
        }
        /* <div>をルリグデッキに追加 */
        lrigDeckCards.appendChild(cardElement);
        /* ルリグデッキをソート */
        sortLrigDeck();
    }
    /* シグニ,スペル,サーバントならメインデッキに追加してソート */
    else if (['シグニ', 'スペル', 'サーバント'].includes(cardType)) {
        /* メインデッキは40枚まで */
        if (mainDeckCards.children.length >= 40) {                                          // MainDeckの枚数が40枚以上なら処理を停止
            return;
        }
        /* 同名カードは4枚まで */
        const mainSameNameCards = Array.from(mainDeckCards.children).filter(deckCard => {   // メインデッキの中身を配列で取得
            const deckCardName = deckCard.dataset.name;                                        // datasetからカード名を取得
            return deckCardName === cardElement.dataset.name;                                  // 取得したカード名の中に、追加しようとしているカードと同じものがあるかどうかをチェック
        });
        if (mainSameNameCards.length >= 4) {                                                // 4枚以上あるなら処理を停止
            return;
        }
        /* <div>をメインデッキに追加 */
        mainDeckCards.appendChild(cardElement);
        /* メインデッキをソート */
        sortMainDeck();
    }

    // カードにフリックイベントを追加
    cardElement.addEventListener('touchstart', handleTouchStart);
    cardElement.addEventListener('touchend',  (event) => {           // タップ終了時のリスナーを追加
        currentCard = card;                                           // 触れているカードをcurrentCardとして保存(handleTouchEndで使用)
        handleTouchEndOnDeck(event);                                  // handleTouchEndOnDeckを呼び出す
    });

    // ステータス欄を更新
    updateDeckStatus();
}


/* ルリグデッキのソート */
function sortLrigDeck() {
    /* lrigDeckの子要素(ルリグデッキのカード)を取得 */
    const cardElements = Array.from(lrigDeckCards.children);

    /* カード種類によるソート順を設定 */
    const lrigDeckOrder = {
        'ルリグ': 1,
        'アシストルリグ': 2,
        'ピース': 3,
        'アーツ': 4
    };

    /* ソート */
    cardElements.sort((a, b) => {
        /* カード種類でソート */
        const aCardType = lrigDeckOrder[a.dataset.cardType] || 5;   // カード種類を取得し、ソート順に応じた値を持たせる
        const bCardType = lrigDeckOrder[b.dataset.cardType] || 5;
        if (aCardType !== bCardType) {
            return aCardType - bCardType                            // 違うカード種類ならソート
        }
        /* アシストルリグのソート */
        if (a.dataset.cardType === 'アシストルリグ' && b.dataset.cardType === 'アシストルリグ') {
            /* ルリグタイプでソート */
            const aLrigTypeClass = a.dataset.lrigTypeClass;            // ルリグタイプを取得
            const bLrigTypeClass = b.dataset.lrigTypeClass;
            if (aLrigTypeClass !== bLrigTypeClass) {
                return aLrigTypeClass.localeCompare(bLrigTypeClass);   // 違うルリグタイプなら文字列でソート
            }
            /* ルリグタイプが同じならレベルでソート */
            const aLevel = a.dataset.level;                            // レベルを取得
            const bLevel = b.dataset.level;
            return aLevel - bLevel;                                    // aとbで比較
        }
        /* アシストルリグ以外で同じカード種類ならカード名でソート */
        const aName = a.dataset.name;                                  // カード名を取得
        const bName = b.dataset.name;
        return aName.localeCompare(bName);                             // カード名でソート
    });

    lrigDeckCards.innerHTML = '';
    cardElements.forEach(element => lrigDeckCards.appendChild(element));
}


/* メインデッキソート */
function sortMainDeck() {
    /* mainDeckの子要素（メインデッキのカード）を取得 */
    const cardElements = Array.from(mainDeckCards.children);

    /* カード種類によるソート順を設定 */
    const mainDeckOrder = {
        'シグニ': 1,
        'スペル': 2,
        'サーバント': 3
    };

    /* ソート */
    cardElements.sort((a, b) => {
        /* カード種類でソート */
        const aCardType = mainDeckOrder[a.dataset.cardType] || 4;   // カード種類を取得し、ソート順に応じた値を持たせる
        const bCardType = mainDeckOrder[b.dataset.cardType] || 4;
        if (aCardType !== bCardType) {
            return aCardType - bCardType                            // 違うカード種類ならaソート
        }
        /* 同じカード種類ならレベルでソート */
        const aLevel = a.dataset.level;                             // レベルを取得
        const bLevel = b.dataset.level;
        if (aLevel !== bLevel) {
        return aLevel - bLevel;                                     // 違うレベルならソート
        }
        /* レベルが同じ場合、名前でソート */
        const aName = a.dataset.name;                               // カード名を取得
        const bName = b.dataset.name;
        return aName.localeCompare(bName);                          // カード名でソート
    });

    mainDeckCards.innerHTML = '';
    cardElements.forEach(element => mainDeckCards.appendChild(element));
}


/* ステータス欄を更新する関数 */
function updateDeckStatus() {

    /* 各種カウントをリセット */
    let lv1StatusCount = 0;     //Lv1
    let lv2StatusCount = 0;     //Lv2
    let lv3StatusCount = 0;     //Lv3
    let lbStatusCount = 0;      //LB
    let whiteStatusCount = 0;   //白
    let redStatusCount = 0;     //赤
    let blueStatusCount = 0;    //青
    let greenStatusCount = 0;   //緑
    let blackStatusCount = 0;   //黒

    /* メインデッキ内の各カードをチェック */
    Array.from(mainDeckCards.children).forEach(cardElement => {                   // メインデッキの子要素(cardたち)を取得
        const cardName = cardElement.dataset.name;                                   // カードのdatasetの名前を取得
        const cardData = window.cardsData.find(card => card.name === cardName);      // カードリストから名前で検索し、データを取得
        /* 該当するものがあればカウントを1増やす */
        if (cardData && cardData.level === 1) {lv1StatusCount++;}                    // Lv1
        if (cardData && cardData.level === 2) {lv2StatusCount++;}                    // Lv2
        if (cardData && cardData.level === 3) {lv3StatusCount++;}                    // Lv3
        if (cardData && cardData.color.includes("白")) {whiteStatusCount++;}         // 白
        if (cardData && cardData.color.includes("赤")) {redStatusCount++;}           // 赤
        if (cardData && cardData.color.includes("青")) {blueStatusCount++;}          // 青
        if (cardData && cardData.color.includes("緑")) {greenStatusCount++;}         // 緑
        if (cardData && cardData.color.includes("黒")) {blackStatusCount++;}         // 黒
        if (cardData && cardData.lifeBurst === 1) {lbStatusCount++;}                 // lifeBurstが1のカード
    });

    /* 各種枚数を表示 */
    document.getElementById('lv1-status-count').textContent = `${lv1StatusCount}`;       //Lv1
    document.getElementById('lv2-status-count').textContent = `${lv2StatusCount}`;       //Lv2
    document.getElementById('lv3-status-count').textContent = `${lv3StatusCount}`;       //Lv3
    document.getElementById('lb-status-count').textContent = `${lbStatusCount}`;         //LB
    document.getElementById('white-status-count').textContent = `${whiteStatusCount}`;   //白
    document.getElementById('red-status-count').textContent = `${redStatusCount}`;       //赤
    document.getElementById('blue-status-count').textContent = `${blueStatusCount}`;     //青
    document.getElementById('green-status-count').textContent = `${greenStatusCount}`;   //緑
    document.getElementById('black-status-count').textContent = `${blackStatusCount}`;   //黒
}


/* デッキ欄のフリック・タップ設定 */

/* タッチ開始時はリスト欄と同じ関数を流用 */
    // function handleTouchStart(event) {
/* タッチ終了時 */
function handleTouchEndOnDeck(event) {
    const touchEndY = event.changedTouches[0].clientY;   // タッチ終了時のY座標を取得
    const swipeDistance = touchStartY - touchEndY;       // フリックの距離を計算
    /* 上方向にフリックされた場合、デッキにもう1枚追加 */
    if (swipeDistance > 50 && currentCard) {
        addCardToDeck(currentCard);
    }
    /* 下方向にフリックされた場合、デッキから削除 */
    else if (swipeDistance < -50 && currentCard) {
        if (lrigDeckCards.contains(currentCard)) {
            lrigDeckCards.removeChild(currentCard);
            sortLrigDeck();
        } else if (mainDeckCards.contains(currentCard)) {
            mainDeckCards.removeChild(currentCard);
            sortMainDeck();
        }
    }
    /* タップされた場合、ポップアップで拡大表示(フリックがほぼないかつ触った時間が0.2秒未満(擬似的なタップ)) */
    else if (Math.abs(swipeDistance) < 5 && touchDuration < 0.2) {
        // タップの処理
    }
}

/* デッキ欄のカード上フリックでそのカードをさらに追加（複製）*
function handleDuplicateTouchEnd(event) {
    /* タッチ終了時のY座標を取得し、フリックの距離を計算 *
    const touchEndY = event.changedTouches[0].clientY;
    const swipeDistance = touchStartY - touchEndY;

    /* 上方向にスワイプされた場合、カードを複製 *
    if (swipeDistance > 50 && event.currentTarget) {
        duplicateCard(event.currentTarget);
    }
}
/* 複製の関数 *
function duplicateCard(cardElement) {

    const cardName = cardElement.dataset.name;
    const cardData = window.cardsData.find(card => card.name === cardName);
    // addCardToDeck関数を使ってカードを追加
    addCardToDeck(cardData);
}

/* デッキ欄のカードを下フリックでデッキから削除 *
function handleRemoveTouchEnd(event) {

    /* タッチ終了時のY座標を取得し、フリックの距離を計算 *
    const touchEndY = event.changedTouches[0].clientY;
    const swipeDistance = touchEndY - touchStartY;

    /* 下方向にスワイプされた場合、カードを削除 *
    if (swipeDistance > 50 && event.currentTarget) {
        removeCardFromDeck(event.currentTarget);
    }
}
/* 削除の関数 *
function removeCardFromDeck(cardElement) {
    const lrigDeck = document.getElementById('lrig-deck-cards');
    const mainDeck = document.getElementById('main-deck-cards');

    if (lrigDeck.contains(cardElement)) {
        lrigDeck.removeChild(cardElement);
        sortLrigDeck();
    } else if (mainDeck.contains(cardElement)) {
        mainDeck.removeChild(cardElement);
        sortMainDeck();
    }

    /* ステータス欄を更新 *
    updateDeckStatus();
}



/* ---------------------------------------------------------------------------------------------------------------------- */});/* -おわり- */